#include <at89x051.h>
#include "uart.h"

volatile char uart_rxbuf[UART_RX_BUF_SIZE];
volatile unsigned char uart_rxhead;
volatile unsigned char uart_rxtail;

void uart_init (void) {
  TMOD &= ~0xF0;
  TMOD |= 0x20;
  SCON = 0x50;
  TH1  = 0xFD;
  TL1  = 0xFD;
  ES   = 1;
  TR1  = 1;
}

void uart_putchar(unsigned char dat) {
	while(!TI);
	TI = 0;
	SBUF = dat;
}

/*
unsigned char uart_read (void) {
	while(!RI);
	RI = 0;
	return SBUF;
}
*/

int uart_getchar (void) {
  if (uart_rxhead == uart_rxtail) return -1;
  uart_rxtail = (uart_rxtail + 1) & UART_RX_BUF_SIZE;
  return uart_rxbuf[uart_rxtail];
}


void uart_isr (void) __interrupt (4) {

  register unsigned char tmp_head;
  register char data;
  
  if (RI) {
    RI = 0;
    data = SBUF;
    tmp_head = (uart_rxhead + 1) & UART_RX_BUF_MASK;
    if (tmp_head == uart_rxtail) {
      uart_rxhead = uart_rxtail;
    }
    else {
      uart_rxhead = tmp_head;
      uart_rxbuf[tmp_head] = data;
    }
  }

  if (TI) {
    TI = 0;
  }
}
